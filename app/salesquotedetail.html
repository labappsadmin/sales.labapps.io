<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quote Details - Sales Module</title>
    <link rel="shortcut icon" type="image/x-icon" href="../favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="../assets/css/style.css">
    <link href="../lib/butterup-2.0.0/butterup.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@latest/pace-theme-default.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <a href="../" class="sidebar-logo">LabApps</a>
        </div>
        <div id="sidebarMenu" class="sidebar-body"></div>
    </div>
    <div class="header-main px-3 px-lg-4">
        <a id="menuSidebar" href="#" class="menu-link me-3 me-lg-4"><i class="ri-menu-2-fill"></i></a>
        <div class="form-search me-auto">
            <input type="text" class="form-control" id="tappsearch" placeholder="Search Sales">
            <i class="ri-search-line"></i>
        </div>
        <div class="dropdown dropdown-profile ms-3 ms-xl-4">
            <a href="" class="dropdown-link" data-bs-toggle="dropdown" data-bs-auto-close="outside">
                <div class="avatar online"><img src="../assets/img/img1.jpg" alt="" class="spanuserimg"></div>
            </a>
            <div class="dropdown-menu dropdown-menu-end mt-10-f">
                <div class="dropdown-menu-body">
                    <div class="avatar avatar-xl online mb-3"><img src="../assets/img/img1.jpg" alt="" class="spanuserimg"></div>
                    <h5 class="mb-1 text-dark fw-semibold spanusername">User</h5>
                    <p class="fs-sm text-secondary spanuserrole mb-1">Sales User</p>
                    <nav class="nav">
                        <a target="_blank" href="https://labapps.gitbook.io"><i class="ri-question-line"></i> Help Center</a>
                        <a href="../app/userprofile.html"><i class="ri-user-settings-line"></i> Account Settings</a>
                        <a href="#!" onclick="logoutuser();"><i class="ri-logout-box-r-line"></i> Log Out</a>
                    </nav>
                </div>
            </div>
        </div>
    </div>
    <div class="main main-app p-3">
        <div class="content">
            <div class="container">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <div>
                        <ol class="breadcrumb fs-sm mb-1">
                            <li class="breadcrumb-item"><a href="saleshome.html">Dashboard</a></li>
                            <li class="breadcrumb-item"><a href="salesquotes.html">Quotes</a></li>
                            <li class="breadcrumb-item active">Quote Details</li>
                        </ol>
                        <h4 class="main-title mb-0" id="quoteTitle">Quote Details</h4>
                    </div>
                    <nav>
                        <button type="button" class="btn btn-sm btn-primary" onclick="saveQuote()">
                            <i class="ri-save-line"></i> Save
                        </button>
                        <button type="button" class="btn btn-sm btn-success" onclick="convertToOrder()">
                            <i class="ri-shopping-cart-line"></i> Convert to Order
                        </button>
                        <button type="button" class="btn btn-sm btn-info" onclick="createVersion()">
                            <i class="ri-file-copy-line"></i> New Version
                        </button>
                    </nav>
                </div>
                <hr />
                <div class="row">
                    <div class="col-md-8">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Quote Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <strong>Quote Number:</strong> <span id="quoteNumber">-</span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Status:</strong> <span id="quoteStatus" class="badge bg-info">-</span>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <strong>Account:</strong> <span id="quoteAccount">-</span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Valid Until:</strong> <span id="quoteValidUntil">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Line Items</h5>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Item</th>
                                            <th>Quantity</th>
                                            <th>Unit Price</th>
                                            <th>Discount</th>
                                            <th>Line Amount</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="quoteItemsBody">
                                        <tr><td colspan="6" class="text-center">Loading items...</td></tr>
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <th colspan="4" class="text-end">Total:</th>
                                            <th id="quoteTotal">$0.00</th>
                                            <th></th>
                                        </tr>
                                    </tfoot>
                                </table>
                                <button class="btn btn-sm btn-primary" onclick="addQuoteItem()">
                                    <i class="ri-add-line"></i> Add Item
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Quick Actions</h5>
                            </div>
                            <div class="card-body">
                                <button class="btn btn-sm btn-primary w-100 mb-2" onclick="approveQuote()">
                                    <i class="ri-check-line"></i> Approve Quote
                                </button>
                                <button class="btn btn-sm btn-info w-100 mb-2" onclick="generatePDF()">
                                    <i class="ri-file-pdf-line"></i> Generate PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="../lib/jquery/jquery.min.js?v=2.7.0"></script>
    <script src="../lib/bootstrap/js/bootstrap.bundle.min.js?v=2.7.0"></script>
    <script src="../lib/perfect-scrollbar/perfect-scrollbar.min.js?v=2.7.0"></script>
    <script src="../lib/jqueryui/jquery-ui.min.js?v=2.7.0"></script>
    <script src="../assets/js/script.js?v=2.7.0"></script>
    <script src="../assets/js/core.js?v=2.7.0"></script>
    <script src="../assets/js/auth.js?v=2.7.0"></script>
    <script src="../lib/butterup-2.0.0/butterup.js?v=2.7.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/pace-js@latest/pace.min.js?v=2.7.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
    <script src="../assets/js/cross-domain-auth.js?v=2.7.0"></script>
    <script src="../assets/js/salescore.js?v=2.7.0"></script>
    <script src="../assets/js/salesquotes.js?v=2.7.0"></script>
    <script type="text/javascript">
        var currentQuoteId = null;
        $(document).ajaxStart(function () { Pace.restart(); });
        $(document).ready(function () {
            $('.spanusername').html(displayname);
            $('.spanuserimg').attr('src', userimage);
            initAuthErrorHandling();
            loadDynamicMenu();
            var urlParams = new URLSearchParams(window.location.search);
            currentQuoteId = urlParams.get('id');
            if (currentQuoteId && orgid) {
                loadQuoteDetails(currentQuoteId);
            }
        });
        function loadQuoteDetails(quoteId) {
            salesApiCall('/api/salesquotes/' + quoteId + '?orgid=' + orgid, 'GET', null, function(quote) {
                $('#quoteTitle').text('Quote #' + quote.quotenumber);
                $('#quoteNumber').text(quote.quotenumber);
                $('#quoteStatus').text(quote.status);
                $('#quoteAccount').text(quote.accountname);
                $('#quoteValidUntil').text(formatDate(quote.validuntil));
                $('#quoteTotal').text('$' + formatCurrency(quote.totalamount));
                
                renderQuoteItems(quote.items);
            });
        }
        function renderQuoteItems(items) {
            var html = '';
            if (items && items.length > 0) {
                items.forEach(function(item) {
                    html += '<tr>' +
                           '<td>' + (item.itemname || 'N/A') + '</td>' +
                           '<td>' + (item.quantity || 0) + '</td>' +
                           '<td>$' + formatCurrency(item.unitprice) + '</td>' +
                           '<td>' + (item.discount || 0) + '%</td>' +
                           '<td>$' + formatCurrency(item.lineamount) + '</td>' +
                           '<td><button class="btn btn-sm btn-danger" onclick="removeQuoteItem(' + item.itemid + ')"><i class="ri-delete-bin-line"></i></button></td>' +
                           '</tr>';
                });
            } else {
                html = '<tr><td colspan="6" class="text-center text-muted">No items</td></tr>';
            }
            $('#quoteItemsBody').html(html);
        }
        function addQuoteItem() {
            Swal.fire({
                title: 'Add Line Item',
                html: '<input type="text" class="form-control mb-2" id="itemName" placeholder="Item Name *" required />' +
                      '<input type="number" class="form-control mb-2" id="itemQuantity" placeholder="Quantity" step="0.01" />' +
                      '<input type="number" class="form-control mb-2" id="itemUnitPrice" placeholder="Unit Price" step="0.01" />' +
                      '<input type="number" class="form-control mb-2" id="itemDiscount" placeholder="Discount %" min="0" max="100" />',
                showCancelButton: true,
                confirmButtonText: 'Add',
                preConfirm: function() {
                    return {
                        quoteid: currentQuoteId,
                        itemname: $('#itemName').val(),
                        quantity: $('#itemQuantity').val() ? parseFloat($('#itemQuantity').val()) : 1,
                        unitprice: $('#itemUnitPrice').val() ? parseFloat($('#itemUnitPrice').val()) : 0,
                        discount: $('#itemDiscount').val() ? parseFloat($('#itemDiscount').val()) : 0
                    };
                }
            }).then(function(result) {
                if (result.isConfirmed) {
                    salesApiCall('/api/salesquotes/' + currentQuoteId + '/items', 'POST', [result.value], function(response) {
                        showSalesSuccess('Item added successfully');
                        loadQuoteDetails(currentQuoteId);
                    });
                }
            });
        }
        function removeQuoteItem(itemId) {
            confirmSalesAction('Remove this item?', function() {
                // Implementation would remove item from quote
                loadQuoteDetails(currentQuoteId);
            });
        }
        function saveQuote() {
            showSalesSuccess('Quote saved successfully');
        }
        function convertToOrder() {
            if (!currentQuoteId) return;
            salesApiCall('/api/salesquotes/' + currentQuoteId + '/convert-order', 'POST', null, function(response) {
                showSalesSuccess('Quote converted to order successfully');
                window.location.href = 'salesorderdetail.html?id=' + response.orderid;
            });
        }
        function createVersion() {
            if (!currentQuoteId) return;
            salesApiCall('/api/salesquotes/' + currentQuoteId + '/version', 'POST', null, function(response) {
                showSalesSuccess('New version created');
                window.location.reload();
            });
        }
        function approveQuote() {
            if (!currentQuoteId) return;
            salesApiCall('/api/salesquotes/' + currentQuoteId + '/approve', 'POST', { approved: true }, function(response) {
                showSalesSuccess('Quote approved');
                loadQuoteDetails(currentQuoteId);
            });
        }
        function generatePDF() {
            if (!currentQuoteId) return;
            window.open(getapiendpoint() + '/api/salesquotes/' + currentQuoteId + '/pdf?orgid=' + orgid, '_blank');
        }
    </script>
</body>
</html>

